## ブランチルールを考える

多人数でgitを使う時、一番ミスが起こりやすいのはブランチ操作です。
ブランチのルールを決めることでミスを減らしましょう。

### なにを避けたいか

本番環境にリリースされるのはmasterブランチです。
このmasterブランチに糞を絶対に混ぜてはいけません。
masterブランチは歴史改変を基本的にするべきではないので、
一度間違った状態になったmasterブランチはずっと黒歴史として残ってしまいます。

ブランチ運用で起こしがちなミスを分析し、ミスが起こらないブランチ運用を目指しましょう。
例えばこのようなミスが起こります。

#### 入ってはいけないコードが入る

新しいブランチを作るとき、必ず派生元のブランチがあります。
この派生元のブランチを間違えると大変なことが起こります。

例えば、AブランチからBブランチを作り、Bブランチでひとつの機能を完成させたとします。
Bブランチで作られた機能は十分にテストされているので、安心してmasterにマージするでしょう。
この時、Bブランチだけをマージするつもりが、派生元のAブランチの内容までマージされてしまいます。
もしAブランチが全然未完成だったらどうなるでしょう?

#### 消してはいけないブランチを消してしまう

そんなミスしねえよと思うでしょうが、実際は気をつけないとよく起こります。
例えばリニューアル案件のためにrenewalというブランチを共有していたとします。
一旦入れた開発中のコードを取りやめるときに、developmentブランチと同じ要領でぶっ壊して作りなおしたりしたくなるでしょう。
この時、もし他の人がrenewalはmasterと同じように開発が終わったコードのみを入れるブランチだと思っていたらどうなるでしょう?
もしかしたらrenewalにマージしたブランチはすでに消してしまっているかもしれません。
チーム内で認識の相違があると、いつの間にか他の人のブランチを消してしまうことになってしまいます。

### ブランチルールの例

実際に運用して上手くいったブランチ運用ルールを例として示します。

#### ブランチはmasterから切る

まず、絶対的に *正しいコードはmasterブランチにある* ことを思い出しましょう。

基本的に、 すべてのブランチは **masterブランチから** 切ります。
そうするとそのブランチは、現在動いているコードから、
自分がコミットした以外には何も変更されていないことになります。
もちろん、この状態は変更をテストしやすく、見通しが良い状態です。

#### 全ての変更はトピックブランチにコミットする

**トピックブランチ** とは、ひとまとまりの機能を作るための専用のブランチのことです。
機能ごとに適切な名前のトピックブランチを作り、作業は全てトピックブランチにコミットします。
つまり、 *masterブランチに直接コミットしてはいけない* ということです。
トピックブランチで開発された成果は、マージコマンドにより最終的にmasterに合流します。

```
$ git checkout master
$ git checkout -b topic_A
$ (commit...commit...commit)
$ git checkout master
$ git merge --no-ff topic_A
```

一つのトピックブランチに目的の機能と関係ない変更を加えるのは基本的にしてはいけません。
目的の機能のために、基礎となるクラスに変更を加えるなどの場合、
もしそれがフレームワークの普遍的な部分だとしたら、
やはり別のトピックブランチで作業をする方がいいでしょう。
その場合、フレームワークへの変更を先にmasterにマージし、
トピックブランチをmasterからrebaseします。

#### リモートブランチにも直接コミットしない

**リモートブランチ** とは、他の人と共有しているブランチです。
基本的に他の人と作業を共有するべきではありません。
とは言っても、コードを書くプログラマとhtmlを書くデザイナが協力してひとつの機能を作る、
などのように役割が分担されていたりする場合は、
一つのトピックに二人の作業がコミットされることになります。
このような場合に、トピックブランチをリモートブランチとして共有します。

このリモートブランチは、トピック開発という小さな世界のmasterブランチのようなものなので、
masterと同様に直接コミットしてはいけません。
トピックマスターとでも呼ぶことにします。
自分の作業は、トピックマスターから更にトピックブランチを作り、そこにコミットします。
作業が終わったトピックブランチはもちろんトピックマスターにマージします。

自分がトピックをはじめる場合は次のようなコマンドになります。

```
$ git checkout master
$ git checkout -b topic_master
$ git push origin topic_master # リモートブランチとして共有される
$ git checkout -b topic_A      # 更にトピックブランチを作る
$ (commit)
$ git checkout topic_master
$ git merge --no-ff topic_A    # topic_masterに自分のtopic_Aをマージ
$ git push origin topic_master # 更新をpush
```

他の人が作り始めたトピックに後乗りする場合は次のようなコマンドになります。

```
$ git checkout master
$ git checkout -b topic_master origin/topic_master # リモートかローカルブランチを作る
$ git checkout -b topic_A      # 更にトピックブランチを作る
(これ以降は上と同じ)
```

全ての作業が終わったら、トピックマスターをmasterにマージします。

#### 開発環境にデプロイ

自動テストで十分テストできたら、次のステップはdevelopment環境へのデプロイです。
開発したトピックブランチをdevelopブランチにマージし、デプロイします。
developブランチももちろんmasterから切ります。

developブランチは、開発者全員からトピックブランチを頻繁にマージされる、総受けブランチです。
この段階でマージされるコミットは、どれだけ汚くても構いません。
試行錯誤のコミットやfixとしか書かれていないコミットメッセージでも全然問題ありません。
どんどんデプロイしていきましょう。

開発を続けていくと、developブランチは非常に汚いブランチになります。
こうなった場合は、綺麗サッパリ作り直しましょう。
リモートのdevelopブランチを消し、もう一度masterから作り直します。
作りなおしたdevelopブランチにに、トピックブランチを歴史改変で整理してからもう一度マージすれば、
今度は以前より綺麗なdevelopブランチになります。

developブランチを作り直したいきっかけは他にも、
リリース予定のブランチだけをマージしたdevelopを作ったり、
リリース直後に次の開発のためにmasterから切り直して綺麗サッパリしたり、
頻繁にあると思います。

#### 本番に反映

次はいよいよ本番への反映です。
開発したトピックブランチをmasterにマージして本番デプロイをすることになります。
リリースのタイミングは会社やプロジェクトによって様々だと思います。

頻繁に本番リリースが許されている会社の場合、
開発が終わったトピックブランチ一つをmasterにマージして、
すぐにデプロイするという方法が取れます。
この場合、ほとんど他の人との調整をしなくて済むので、問題が起こることは非常に稀です。

1イテレーション(例えば1週間)に1回、定期リリースをするような運用方法の場合、
1回のリリースに複数の人がトピックブランチを持ち寄ることになります。
全員のトピックブランチのマージが上手く行かない事や、
単体ブランチのテストは上手く行っているが全部合わせた時のテストが失敗する場合があります。
もし直接masterにマージしていたら、masterに一瞬テストが落ちるという状態が発生してしまい、
あまり良くない状態だと言えます。

これを避けるためには、いったんリリース予定のトピックブランチを全て集めた、
**releaseブランチ** を作るといいでしょう。
もちろんreleaseブランチはmasterから切ります。
すべてのトピックブランチをreleaseブランチにマージし、
コンフリクトが起こったら解決し、自動テストが全部通るのを確認します。
テストが通ったら、新たにmasterから切り直したdevelopブランチにreleaseブランチをマージし、
開発環境にデプロイして動作確認します。
動作確認が正常に終了したら、releaseブランチをmasterブランチにマージし(この時コンフリクトは絶対起きません)、
本番環境にデプロイします。

